# PointMarker 利用者の手引
**Version 2025年8月版**

## はじめに
PointMarkerは、ハイキングマップの画像からポイントやルートをマーキングし、座標データを管理するWebアプリケーションです。登山計画の作成や、実際に歩いたルートの記録に活用できます。

## システム要件

### 対応ブラウザ
- **推奨**：Chrome 86以降、Firefox 最新版、Safari 14以降、Edge 86以降
- **必要な機能**：HTML5 Canvas、FileReader API、ES6モジュール対応

### ファイル形式
- **入力画像**：PNG形式のみ
- **データ保存**：JSON形式

### ネットワーク
- インターネット接続不要（ローカル処理のみ）
- すべてのデータはローカルファイルに保存

## 基本的な使い方

### 1. アプリケーションの起動
1. `index.html`ファイルをWebブラウザで開きます
2. モダンブラウザ（Chrome、Firefox、Safari、Edge）の最新版を使用してください

### 2. 地図画像の読み込み
1. **「PNG画像を選択」**ボタンをクリック
2. ハイキングマップのPNG画像ファイルを選択
3. 画像が自動的にキャンバスに表示されることを確認

**注意事項：**
- PNG形式の画像のみ対応（JPEG、GIF等は非対応）
- 画像は表示領域に合わせて自動スケーリングされます
- アスペクト比は保持されます

### 3. レイアウトの選択
画面上部で2つのレイアウトから選択できます：
- **サイドバー**（推奨）：地図とコントロールパネルが横並び表示
- **オーバーレイ**：コントロールパネルが地図上に重ね表示

## ポイント編集機能

### ポイントの配置
1. **「ポイント編集」**モードを選択（デフォルト）
2. 地図上の任意の場所をクリック
3. 赤い円マーカーが表示され、動的にID入力ボックスがポップアップ
4. ポイントIDを入力（X-nn形式：例 A-01、J-12）

### ポイントID管理
- **形式**: X-nn（英大文字1桁-数字2桁）
- **自動補正**: 全角→半角変換、0埋め処理
- **入力制御**: 入力中は補正なし、フォーカス離脱時に自動補正
- **バリデーション**: リアルタイム形式チェック、エラー表示

### ポイントの移動
**新機能**: ドラッグ＆ドロップによるポイント移動
1. 配置済みのポイント（赤い円）の上にマウスを移動
2. マウスカーソルが移動アイコン（十字矢印）に変化することを確認
3. ポイントの上でマウスをクリック＆ドラッグ
4. 希望の位置まで移動してマウスボタンを離す
5. ポイントが新しい位置に移動し、ID入力ボックスも自動で再配置

**制限事項**：
- ポイント移動はポイント編集モードでのみ有効
- ルート編集モード中は移動できません

### ポイントの削除
- **Escapeキー**: 選択中のポイント削除
- **空入力**: ID入力ボックスを空にしてフォーカスを外すと削除

### 一括操作
- **「ポイントをクリア」**: すべてのポイントを即座に削除
- **「ポイントID名の補正」**: 全ポイントの一括フォーマット＋空ポイント削除
- **「ポイントをJSON出力」**: ポイントデータをJSON形式で保存
- **「ポイントのJSON読込」**: 既存JSONファイルからポイント復元

## ルート編集機能

### ルート編集の準備
1. 事前にポイント編集でルートの開始・終了点を配置
2. **「ルート編集」**モードに切り替え
3. 既存ポイントの編集が自動的に制限されます

### ルートの作成手順
1. **開始ポイント**欄に開始点のID（例：A-01）を入力
2. **終了ポイント**欄に終了点のID（例：B-05）を入力
3. 指定されたポイントは白背景＋青枠で強調表示
4. 地図上でルートの中間点をクリックして順次配置
5. 青い小円で中間点が表示され、ルートラインで接続

### ルート編集時の制限
- **ポイント編集禁止**: 既存ポイントの移動・削除が無効
- **入力フィールド無効化**: 背景色が薄い灰色に変更
- **開始終了ポイント強調**: 指定ポイントの背景が白色、青枠で強調

### データ検証
ルート出力前に以下をチェック：
- 開始ポイントが既存ポイントとして存在するか
- 終了ポイントが既存ポイントとして存在するか  
- 中間点が1つ以上配置されているか

### ルートデータの操作
- **「ルートをクリア」**: 全中間点と開始・終了ポイント設定を削除
- **「ルートをJSON出力」**: ルートデータをJSON形式で保存
- **「ルートのJSON読込」**: 既存ルートJSONからデータ復元

## ファイル操作

### 自動ファイル名生成
保存時のファイル名は自動生成されます：
- **ポイント**: `{画像名}_points.json`
- **ルート**: `{画像名}_route_{開始ポイント}_to_{終了ポイント}.json`

例：`hakusan_route_A-01_to_B-05.json`

### 保存機能
**File System Access API**対応ブラウザでは高度な保存機能を利用：
- ファイル名・保存場所の指定
- 既存ファイルの上書き確認
- 非対応ブラウザでは従来のダウンロード機能

### 読み込み機能
1. 対応するJSONファイルを選択
2. データが自動的にキャンバスに復元
3. 座標は現在の表示に合わせて自動調整

**注意事項：**
- 読み込み前に対応する地図画像を読み込んでください
- 不正なJSONファイルはエラーメッセージを表示

## 画面の見方

### メイン画面の構成
- **キャンバス領域**: 地図画像とマーカーの表示
- **コントロールパネル**: 操作ボタンとモード切り替え
- **動的UI要素**: ポイント位置に表示される入力ボックス
- **ステータス表示**: ポイント数・中間点数のリアルタイム表示

### マーカーの色分け
- **赤い円**: 配置したポイント（IDラベル付き）
- **青い小円**: ルートの中間点
- **白背景＋青枠**: ルート編集時の開始・終了ポイント
- **薄い灰色背景**: ルート編集時の通常ポイント
- **ルートライン**: 開始→中間点→終了を結ぶ線

### マウスカーソルの変化
- **十字矢印（move）**: ポイント上でのホバー時（移動可能状態）
- **通常のカーソル**: ポイント外での通常状態
- **十字線（crosshair）**: キャンバス上での新ポイント配置時

### レスポンシブ対応
- **デスクトップ**: サイドバーレイアウト推奨
- **モバイル**: オーバーレイレイアウト自動適用
- **ウィンドウリサイズ**: 自動的にキャンバスと座標を調整

## 高度な機能

### 座標系管理
アプリケーションは以下の座標系を内部で管理：
- **画像座標系**: 元PNG画像の実ピクセル座標（JSON保存用）
- **キャンバス座標系**: 表示用スケール座標（描画用）
- **スクリーン座標系**: ブラウザ内絶対座標（UI配置用）

### 動的入力システム
- **自動配置**: ポイント位置に最適な入力ボックス配置
- **画面端考慮**: 画面外に出ない位置調整
- **フォーカス管理**: 入力中の再描画回避によるフォーカス保持

### アクセシビリティ
- **キーボード操作**: Tab移動、Escape削除対応
- **ARIA属性**: スクリーンリーダー対応
- **カラーコントラスト**: WCAG準拠の配色設計

## データ構造

### ポイントJSON形式
```json
{
    "totalPoints": 3,
    "imageReference": "sample.png",
    "imageInfo": {
        "width": 1920,
        "height": 1080
    },
    "points": [
        {
            "index": 1,
            "id": "A-01",
            "imageX": 245,
            "imageY": 387,
            "isMarker": false
        }
    ],
    "exportedAt": "2025-08-24T10:30:00.000Z"
}
```

### ルートJSON形式
```json
{
    "routeInfo": {
        "startPoint": "A-01",
        "endPoint": "B-03",
        "waypointCount": 5
    },
    "imageReference": "sample.png",
    "imageInfo": {
        "width": 1920,
        "height": 1080
    },
    "points": [
        {
            "type": "waypoint",
            "index": 1,
            "imageX": 320,
            "imageY": 450
        }
    ],
    "exportedAt": "2025-08-24T10:45:00.000Z"
}
```

## よくある質問

### Q: 画像が表示されません
A: PNG形式の画像ファイルであることを確認してください。JPEG、GIF等は対応していません。

### Q: ポイントIDが自動補正されません
A: blur（フォーカス離脱）時に補正されます。入力中は補正されない仕様です。

### Q: ルートの開始・終了ポイントを設定できません
A: 事前にポイント編集モードで該当IDのポイントを配置する必要があります。

### Q: 入力中にフォーカスが外れてしまいます
A: 最新版では入力中の再描画を抑制してフォーカスを保持します。問題が続く場合はブラウザを更新してください。

### Q: ポイントを移動できません
A: 以下を確認してください：
- ポイント編集モードになっているか（ルート編集モードでは移動不可）
- ポイント（赤い円）の上にマウスカーソルがあるか
- カーソルが十字矢印（move）に変化しているか

### Q: ドラッグ中にポイントが正しく移動しません
A: マウスカーソルがポイントの中心から離れすぎている可能性があります。ポイントの中心部分をクリックしてドラッグしてください。

### Q: JSONファイルが読み込めません
A: 以下を確認してください：
- PointMarkerで出力したJSONファイルであること
- ファイルが破損していないこと
- 読み込み前に対応する地図画像を読み込んでいること

### Q: ルートJSON出力でエラーが出ます
A: 以下の条件を満たしているか確認してください：
- 開始・終了ポイントが既存ポイントとして存在する
- 中間点が1つ以上配置されている
- 開始・終了ポイント両方が設定されている

### Q: データが消えてしまいました
A: ブラウザ内でのみ動作するため、定期的なJSONファイル保存を推奨します。

## 活用例

### 登山計画の作成
1. 登山ルートマップのPNG画像を読み込み
2. 主要ポイント（山頂、山小屋、分岐点等）をX-nn形式で体系的に配置
3. 計画ルートを中間点で詳細設定
4. JSONデータとして保存し、登山当日にモバイルで参照

### 実歩行記録の作成
1. 実際に歩いたルートの地図を読み込み
2. 立ち寄ったポイントや印象的な場所を記録
3. **ポイント移動機能**を活用して位置を精密調整
4. 実歩行ルートを中間点で精密に再現
5. 記録として保存し、後日振り返りや共有に活用

### 複数ルートの比較検討
1. 同一地図で複数のルートパターンを作成
2. それぞれ別JSONファイルとして保存
3. 必要に応じて読み込み切り替えで比較検討

### 地理情報管理
1. 管理対象エリアの地図にポイント情報を体系化
2. X-nn形式による一貫したID管理
3. JSON形式による他システムとのデータ連携

## トラブルシューティング

### パフォーマンス問題
- **大量ポイント**: 数百以上のポイントで動作が重い場合、ブラウザを再起動
- **大容量画像**: メモリ不足の場合、画像サイズを縮小して再試行
- **レスポンス遅延**: 古いブラウザでは最新版への更新を推奨

### 表示問題
- **座標ズレ**: ウィンドウリサイズ後に発生した場合、画像を再読み込み
- **UI重複**: 動的要素が重複表示された場合、モード切り替えで修正
- **フォーカス問題**: 入力ができない場合、一度他の場所をクリックしてから再試行

### データ問題
- **JSON破損**: バックアップファイルがある場合はそちらを使用
- **座標不整合**: 異なる画像に対するJSONは読み込まない
- **文字化け**: ファイル名に特殊文字が含まれる場合、英数字のみに変更

---

**プライバシーとセキュリティ**
- すべての処理はブラウザ内で完結します
- インターネット接続や外部サーバーへのデータ送信は一切ありません
- データはローカルファイルのみに保存されます
- 個人情報の収集や追跡は行いません

**困ったときは**
操作方法がわからない場合は、この手引を再度ご確認ください。それでも解決しない場合は、ブラウザの更新（Ctrl+F5またはCmd+R）を試してください。

**最終更新**: 2025年8月25日  
**バージョン**: 2.1  
**更新内容**: ポイント移動機能（ドラッグ&ドロップ、ホバーカーソル）の追加